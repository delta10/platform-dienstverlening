apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: objecttypen
  namespace: demodam-demo
spec:
  interval: 5m
  chart:
    spec:
      chart: objecttypen
      version: "1.4.0"
      sourceRef:
        kind: HelmRepository
        name: maykin
  valuesFrom:
    - kind: Secret
      name: objecttypen-secrets
    - kind: Secret
      name: postgresql-cluster-app
      valuesKey: password
      targetPath: settings.database.password
  values:
    tags:
      redis: true

    redis:
      image:
        repository: bitnamilegacy/redis
      master:
        persistence:
          enabled: false

    replicaCount: 1

    image:
      repository: maykinmedia/objecttypes-api
      pullPolicy: IfNotPresent
      tag: "3.3.0"

    ingress:
      enabled: true
      annotations:
        nginx.ingress.kubernetes.io/proxy-body-size: "4G"
      className: "nginx"
      hosts:
       - host: objecttypen.demodam.example.com
         paths:
           - path: /
             pathType: ImplementationSpecific
      tls:
        - hosts:
            - objecttypen.demodam.example.com
          secretName: ingress-tls

    resources:
      limits:
        cpu: 1000m
        memory: 1Gi
      requests:
        cpu: 10m
        memory: 12Mi

    persistence:
      enabled: false
      size: 1Gi
      existingClaim: null
      mediaMountSubpath: objecten/media

    global:
      configuration:
        enabled: true
        overwrite: true

    configuration:
      enabled: true
      initContainer:
        enabled: false
      job:
        enabled: true
        ttlSecondsAfterFinished: 600

      data: |-
        oidc_db_config_enable: True
        oidc_db_config_admin_auth:
          items:
          - identifier: admin-oidc
            enabled: True
            oidc_rp_client_id: registers
            oidc_rp_client_secret: IFpajZi8ktEJwwrw5Sod7clIgtZqg1WW
            oidc_rp_scopes_list:
            - openid
            - email
            - profile
            oidc_rp_sign_algo: RS256
            endpoint_config:
              oidc_op_discovery_endpoint: https://authn.demodam.example.com/realms/pdv/
            username_claim:
            - sub
            groups_claim:
            - groups
            claim_mapping:
              first_name:
              - given_name
              last_name:
              - family_name
              email:
              - email
            sync_groups: true
            sync_groups_glob_pattern: "*"
            default_groups: []
            make_users_staff: true
            superuser_group_names:
            - superuser
            oidc_use_nonce: true
            oidc_nonce_size: 32
            oidc_state_size: 32
            userinfo_claims_source: id_token

        tokenauth_config_enable: true
        tokenauth:
          items:
            - identifier: objecten
              token: something-secret-for-objecten
              contact_person: objecten
              email: objecten@demodam.example.com

    settings:
      allowedHosts: "localhost,objecttypen.demodam.example.com,kiss.demodam.example.com,objecttypen.objecttypen"
      environment: "test"

      database:
        host: postgresql-cluster-rw
        username: pdv
        name: objecttypen

      email:
        host: ""
        port: 25
        username: ""
        useTLS: true
        defaultFrom: "noreply@dienstverlening.demodam.example.com"

      isHttps: true

      debug: false

      twoFactorAuthentication:
        forceOtpAdmin: true
        patchAdmin: true
